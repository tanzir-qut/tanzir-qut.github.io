<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DySee Framework - GitHub Pages</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container-fluid mt-5">
    <h4 class="mb-4">Title: DySee Framework</h4>
    <h5 class="mb-4">Supervisory Team: Prof. Raja Jurdak, Dr Chadni Islam, Dr Gowri Ramachandran</h5>
    <h6 class="mb-4">Sk Tanzir Mehedi, PhD Student, QUT, Australia</h6>
    <hr>
    <h6 class="mb-4">Selected Packages List</h6>
    <hr>
    <select id="pageSize" class="form-select mb-3" style="width: 100px;">
        <option value="10">10</option>
        <option value="50">50</option>
        <option value="100">100</option>
    </select>
    <div id="dataContainer"></div>
    <div id="paginationControls" class="d-flex justify-content-center mt-3"></div>
</div>

<script>
const apiKey = 'XvrZVNG1ELhmjMirjtuyJX9ECMlTYhSAhdvS8UWH0DEOORMN3zZQtd2dV4iFpaKf';
const apiUrl = 'https://ap-southeast-2.aws.data.mongodb-api.com/app/data-holwzcj/endpoint/data/v1/action/find';
const corsProxy = 'https://cors-anywhere.herokuapp.com/';

$(document).ready(function() {
    loadData(1, 10);

    $('#pageSize').on('change', function() {
        const limit = $(this).val();
        loadData(1, limit);
    });
});

async function fetchMongoData(page = 1, limit = 10) {
    const payload = {
        collection: 'Step_5',
        database: 'PyPi_Research',
        dataSource: 'Cluster0',
        filter: {},
        limit: limit,
        skip: (page - 1) * limit
    };

    try {
        const response = await fetch(corsProxy + apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'api-key': apiKey
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('API Response:', data);

        if (!data.documents || data.documents.length === 0) {
            $('#dataContainer').html('<div class="alert alert-warning">No data available from the API.</div>');
            return [];
        }

        return data.documents;
    } catch (error) {
        console.error('Error fetching data:', error);
        $('#dataContainer').html(`<div class="alert alert-danger">Error fetching data: ${error.message}. Check the console for more details.</div>`);
        return [];
    }
}

async function loadData(page, limit) {
    const documents = await fetchMongoData(page, limit);
    let html = '<table class="table table-striped table-hover table-bordered border w-100" style="font-size: 12px;">';
    html += '<thead style="background-color: #999; color: white;"><tr>';

    if (documents.length > 0) {
        const allKeys = Object.keys(documents[0]).slice(1);
        allKeys.forEach(key => {
            html += `<th>${key}</th>`;
        });
        html += '</tr></thead><tbody>';

        documents.forEach(doc => {
            html += '<tr>';
            allKeys.forEach(key => {
                html += `<td>${doc[key] ?? ''}</td>`;
            });
            html += '</tr>';
        });
    } else {
        html += '<tr><td colspan="100%">No data available</td></tr>';
    }

    html += '</tbody></table>';
    $('#dataContainer').html(html);

    setupPagination(page, Math.ceil(1000 / limit), limit);
}

function setupPagination(currentPage, totalPages, limit) {
    let paginationHtml = '';
    paginationHtml += `<button class="btn btn-secondary me-2" ${currentPage === 1 ? 'disabled' : ''} onclick="loadData(1, ${limit})">First</button>`;
    paginationHtml += `<button class="btn btn-secondary me-2" ${currentPage === 1 ? 'disabled' : ''} onclick="loadData(${currentPage - 1}, ${limit})">Previous</button>`;
    paginationHtml += `<span class="mx-2">Page ${currentPage} of ${totalPages}</span>`;
    paginationHtml += `<button class="btn btn-secondary ms-2" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadData(${currentPage + 1}, ${limit})">Next</button>`;
    paginationHtml += `<button class="btn btn-secondary ms-2" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadData(${totalPages}, ${limit})">Last</button>`;
    $('#paginationControls').html(paginationHtml);
}
</script>

</body>
</html>
